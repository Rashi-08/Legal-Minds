<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JURIS_NET ¬∑ Anti-Cheat Engine Demo (Enhanced)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* BASE & TYPOGRAPHY ENHANCEMENTS */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f3f4f6;
            color: #111827;
            min-height: 100vh;
            font-size: 17px;
        }

        .app {
            max-width: 1280px;
            margin: 0 auto;
            padding: 32px 24px 60px;
        }

        /* Top bar */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.6rem;
            background: linear-gradient(135deg, #0a66c2, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-icon {
            font-size: 1.8rem;
        }

        .top-pill {
            font-size: 1rem;
            padding: 8px 14px;
            border-radius: 999px;
            background: #e5f3ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
            font-weight: 600;
        }

        /* Cards */
        .card {
            background: #ffffff;
            border-radius: 18px;
            border: 2px solid #e5e7eb;
            box-shadow: 0 15px 40px rgba(15, 23, 42, 0.08);
            padding: 24px 24px 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title span.icon {
            font-size: 1.5rem;
        }

        .card-subtitle {
            font-size: 0.95rem;
            color: #4b5563;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        /* Hero layout */
        .hero-grid {
            display: grid;
            grid-template-columns: 1.6fr 1.1fr;
            gap: 24px;
            margin-top: 8px;
        }

        @media (max-width: 900px) {
            .hero-grid { grid-template-columns: 1fr; }
            .top-bar { flex-direction: column; align-items: flex-start; gap: 12px; }
        }

        /* Scan button */
        .primary-btn {
            border: none;
            outline: none;
            border-radius: 999px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #0a66c2, #10b981);
            color: #ffffff;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }

        .primary-btn .dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #bbf7d0;
        }

        .hint-text {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 10px;
            line-height: 1.4;
        }

        /* Summary tiles */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
            margin-top: 8px;
        }

        .summary-tile {
            border-radius: 14px;
            padding: 16px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
        }

        .summary-label {
            font-size: 0.85rem;
            color: #4b5563;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .summary-score-row {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 4px;
        }

        .summary-score {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #0a66c2, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .summary-chip {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid;
            font-weight: 500;
        }

        .summary-desc {
            font-size: 0.85rem;
            color: #6b7280;
            line-height: 1.3;
        }

        .legend-row {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #6b7280;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .legend-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 999px;
            margin-right: 4px;
        }

        /* Tables */
        .table-wrap {
            margin-top: 12px;
            border-radius: 14px;
            border: 1px solid #d1d5db;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            background: #ffffff;
        }

        thead {
            background: #eef1f3;
        }

        th, td {
            padding: 12px 14px;
            border-bottom: 1px solid #d1d5db;
            text-align: left;
            vertical-align: middle;
        }

        th {
            font-weight: 700;
            color: #374151;
            font-size: 1rem;
        }

        td {
            color: #4b5563;
        }

        tbody tr:hover {
            background-color: #f5f8fa;
            transition: background-color 0.15s ease;
        }

        tbody tr:nth-child(even) {
            background: #fafafa;
        }

        .reason {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .score-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            font-size: 0.85rem;
            font-weight: 600;
            border-radius: 999px;
            border: 1px solid;
        }

        .chip-low { border-color: #22c55e; background: #ecfdf5; color: #166534; }
        .chip-low span.dot { background: #22c55e; }
        .chip-med { border-color: #eab308; background: #fffbeb; color: #a16207; }
        .chip-med span.dot { background: #eab308; }
        .chip-high { border-color: #ef4444; background: #fef2f2; color: #b91c1c; }
        .chip-high span.dot { background: #ef4444; }

        .score-low { border-color: #22c55e; background: #ecfdf5; color: #166534; }
        .score-med { border-color: #eab308; background: #fffbeb; color: #a16207; }
        .score-high { border-color: #ef4444; background: #fef2f2; color: #b91c1c; }

        .score-badge span.dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
        }

        .empty-row {
            text-align: center;
            color: #9ca3af;
        }
    </style>
</head>
<body>
<div class="app">
    <div class="top-bar">
        <div class="logo">
            <span class="logo-icon">‚öñÔ∏è</span>
            <span>JURIS_NET ¬∑ Anti-Cheat Engine</span>
        </div>
        <div class="top-pill">Live demo ¬∑ Risk scoring only ¬∑ No bans</div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="icon">üß†</span>
                <span>How we prevent farming, boosting & fake activity</span>
            </div>
        </div>
        <div class="card-subtitle">
            Every click, draft and review becomes an event. This engine replays the last 30‚Äì90 days and scores how ‚Äúhuman‚Äù
            each pattern looks for reporters, students and reviewers.
        </div>

        <div class="hero-grid">
            <div>
                <button class="primary-btn" id="run-detectors-btn">
                    <span class="dot"></span>
                    Run Anti-Cheat Scan
                </button>
                <div class="hint-text">
                    In production this would run in the background. For the demo, you click once and we recompute all three scores:
                    <b>Reporter abuse</b>, <b>Student farming</b>, <b>Reviewer boosting</b>.
                </div>
                <div class="hint-text" style="margin-top:10px;">
                    What we look at:
                    <ul style="margin-top:6px; margin-left:20px;">
                        <li>Reporter: unrealistic case volume, category mix & cross-account linkage</li>
                        <li>Student: repeated ‚Äúrevise‚Äù, low-complexity spam, progression & template reuse</li>
                        <li>Reviewer: scoring bias and consistency vs peers on the same draft</li>
                    </ul>
                </div>
            </div>

            <div>
                <div class="card-subtitle" style="margin-bottom:6px; padding-top: 4px;">
                    Latest scan ¬∑ Max suspicion per role (0 = clean, 1 = very suspicious)
                </div>
                <div class="summary-grid" id="summary-grid"></div>
                <div class="legend-row">
                    <span><span class="legend-dot" style="background:#22c55e;"></span>Low</span>
                    <span><span class="legend-dot" style="background:#eab308;"></span>Medium</span>
                    <span><span class="legend-dot" style="background:#ef4444;"></span>High</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Reporter table -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="icon">üôã</span>
                <span>Reporter / User Abuse Detector</span>
            </div>
        </div>
        <div class="card-subtitle">
            ‚ÄúOne person cannot be in a land dispute, traffic case, bonds dispute and defamation fight at the same time.‚Äù
            We flag accounts that file
            <b>too many cases</b>, an <b>unrealistic mix of categories</b>, or that share devices/IPs with student accounts.
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                <tr>
                    <th>Reporter ID</th>
                    <th>Total Cases (30d)</th>
                    <th>Distinct Categories</th>
                    <th>Suspicion</th>
                    <th>Why flagged</th>
                </tr>
                </thead>
                <tbody id="reporter-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Student table -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="icon">üéì</span>
                <span>Student Anti-Cheat / Farming Detector</span>
            </div>
        </div>
        <div class="card-subtitle">
            Students get flagged if they are repeatedly sent back for review, farm only
            <b>low-complexity, copy-pasteable cases</b>, never progress to harder work, or reuse the same draft template across
            many fact patterns. We also flag if their device is the same as a reporter creating cases.
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                <tr>
                    <th>Student ID</th>
                    <th>Submissions (30d)</th>
                    <th>Revise Count</th>
                    <th>Low-Complexity %</th>
                    <th>Avg Turnaround (hrs)</th>
                    <th>Suspicion</th>
                    <th>Why flagged</th>
                </tr>
                </thead>
                <tbody id="student-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Reviewer table -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="icon">üß™</span>
                <span>Reviewer Boosting / Collusion Detector</span>
            </div>
        </div>
        <div class="card-subtitle">
            When five reviewers give a draft 5/10 and one person always gives 10/10, we treat that as a
            <b>bias pattern</b>.
            We compare each reviewer‚Äôs scores against the peer average on the same cases.
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                <tr>
                    <th>Reviewer ID</th>
                    <th>Cases Reviewed</th>
                    <th>Avg Bias vs Peers</th>
                    <th>Bias z-Score</th>
                    <th>Suspicion</th>
                    <th>Why flagged</th>
                </tr>
                </thead>
                <tbody id="reviewer-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    /***********************
     * 1. SIMPLE CONFIG    *
     ***********************/
    const CONFIG = {
        reporterLookbackDays: 30,
        reporterTotalThresh: 7,
        reporterCategoryThresh: 4,
        studentLookbackDays: 30,
        reviseThresh: 3,
        lowComplexThresh: 0.7,
        fastHoursThresh: 6,
        reviewerLookbackDays: 90
    };

    /***********************
     * 2. MOCK EVENT DATA  *
     ***********************/

    // Reporter/user events: case_created
    const events = [
        // Reporter U1: realistic 2 land disputes, own device
        {
            id: 'e1', type: 'case_created', actorId: 'user-001', actorRole:'reporter',
            caseId:'c1', caseCategory:'Land', timestamp:'2025-12-05T10:00:00Z',
            meta: { ip:'198.51.100.10', deviceId:'dev-u1', userAgent:'Mozilla/5.0 ReporterNormal' }
        },
        {
            id: 'e2', type: 'case_created', actorId: 'user-001', actorRole:'reporter',
            caseId:'c2', caseCategory:'Land', timestamp:'2025-12-06T11:00:00Z',
            meta: { ip:'198.51.100.10', deviceId:'dev-u1', userAgent:'Mozilla/5.0 ReporterNormal' }
        },

        // Reporter U2: clearly farming many categories, SHARED device/IP
        {
            id: 'e3', type: 'case_created', actorId: 'user-002', actorRole:'reporter',
            caseId:'c3', caseCategory:'Land', timestamp:'2025-12-01T09:00:00Z',
            meta: { ip:'203.0.113.99', deviceId:'dev-shared-01', userAgent:'Mozilla/5.0 ReporterBot' }
        },
        {
            id: 'e4', type: 'case_created', actorId: 'user-002', actorRole:'reporter',
            caseId:'c4', caseCategory:'Traffic', timestamp:'2025-12-01T09:05:00Z',
            meta: { ip:'203.0.113.99', deviceId:'dev-shared-01', userAgent:'Mozilla/5.0 ReporterBot' }
        },
        {
            id: 'e5', type: 'case_created', actorId: 'user-002', actorRole:'reporter',
            caseId:'c5', caseCategory:'Bonds', timestamp:'2025-12-01T09:10:00Z',
            meta: { ip:'203.0.113.99', deviceId:'dev-shared-01', userAgent:'Mozilla/5.0 ReporterBot' }
        },
        {
            id: 'e6', type: 'case_created', actorId: 'user-002', actorRole:'reporter',
            caseId:'c6', caseCategory:'Defamation', timestamp:'2025-12-01T09:15:00Z',
            meta: { ip:'203.0.113.99', deviceId:'dev-shared-01', userAgent:'Mozilla/5.0 ReporterBot' }
        },
        {
            id: 'e7', type: 'case_created', actorId: 'user-002', actorRole:'reporter',
            caseId:'c7', caseCategory:'Wages', timestamp:'2025-12-02T12:00:00Z',
            meta: { ip:'203.0.113.99', deviceId:'dev-shared-01', userAgent:'Mozilla/5.0 ReporterBot' }
        },
        {
            id: 'e8', type: 'case_created', actorId: 'user-002', actorRole:'reporter',
            caseId:'c8', caseCategory:'Family', timestamp:'2025-12-03T13:00:00Z',
            meta: { ip:'203.0.113.99', deviceId:'dev-shared-01', userAgent:'Mozilla/5.0 ReporterBot' }
        },

        // Reporter U3: lots of traffic cases, own device
        {
            id: 'e9',  type: 'case_created', actorId: 'user-003', actorRole:'reporter',
            caseId:'c9',  caseCategory:'Traffic', timestamp:'2025-12-01T08:00:00Z',
            meta: { ip:'198.51.100.30', deviceId:'dev-u3', userAgent:'Mozilla/5.0 ReporterTraffic' }
        },
        {
            id: 'e10', type: 'case_created', actorId: 'user-003', actorRole:'reporter',
            caseId:'c10', caseCategory:'Traffic', timestamp:'2025-12-02T08:00:00Z',
            meta: { ip:'198.51.100.30', deviceId:'dev-u3', userAgent:'Mozilla/5.0 ReporterTraffic' }
        },
        {
            id: 'e11', type: 'case_created', actorId: 'user-003', actorRole:'reporter',
            caseId:'c11', caseCategory:'Traffic', timestamp:'2025-12-03T08:00:00Z',
            meta: { ip:'198.51.100.30', deviceId:'dev-u3', userAgent:'Mozilla/5.0 ReporterTraffic' }
        },
        {
            id: 'e12', type: 'case_created', actorId: 'user-003', actorRole:'reporter',
            caseId:'c12', caseCategory:'Traffic', timestamp:'2025-12-04T08:00:00Z',
            meta: { ip:'198.51.100.30', deviceId:'dev-u3', userAgent:'Mozilla/5.0 ReporterTraffic' }
        },
        {
            id: 'e13', type: 'case_created', actorId: 'user-003', actorRole:'reporter',
            caseId:'c13', caseCategory:'Traffic', timestamp:'2025-12-05T08:00:00Z',
            meta: { ip:'198.51.100.30', deviceId:'dev-u3', userAgent:'Mozilla/5.0 ReporterTraffic' }
        },
        {
            id: 'e14', type: 'case_created', actorId: 'user-003', actorRole:'reporter',
            caseId:'c14', caseCategory:'Traffic', timestamp:'2025-12-06T08:00:00Z',
            meta: { ip:'198.51.100.30', deviceId:'dev-u3', userAgent:'Mozilla/5.0 ReporterTraffic' }
        },
        {
            id: 'e15', type: 'case_created', actorId: 'user-003', actorRole:'reporter',
            caseId:'c15', caseCategory:'Traffic', timestamp:'2025-12-07T08:00:00Z',
            meta: { ip:'198.51.100.30', deviceId:'dev-u3', userAgent:'Mozilla/5.0 ReporterTraffic' }
        },

        // Reporter U4: small extra reporter sharing the same evil device as user-002
        {
            id: 'e16', type: 'case_created', actorId: 'user-004', actorRole:'reporter',
            caseId:'c16', caseCategory:'Wages', timestamp:'2025-12-03T09:00:00Z',
            meta: { ip:'203.0.113.99', deviceId:'dev-shared-01', userAgent:'Mozilla/5.0 ReporterBot2' }
        },

        // Student events: draft_submitted, review_result
        // S1: honest, mixed complexity, few revisions
        {
          id:'s1-d1', type:'draft_submitted', actorId:'student-001', actorRole:'student',
          caseId:'c101', caseCategory:'Rent', timestamp:'2025-12-03T09:00:00Z',
          meta: {
              complexity: 3,
              claimAt:'2025-12-02T12:00:00Z',
              submitAt:'2025-12-03T09:00:00Z',
              ip:'198.51.100.60',
              deviceId:'dev-s1',
              draftText:'This draft explains the tenant‚Äôs right to protection from illegal eviction and seeks a reasoned reply from the landlord.'
          }
        },
        {
          id:'s1-r1', type:'review_result', actorId:'student-001', actorRole:'student',
          caseId:'c101', caseCategory:'Rent', timestamp:'2025-12-03T18:00:00Z',
          meta: { outcome:'approve' }
        },
        {
          id:'s1-d2', type:'draft_submitted', actorId:'student-001', actorRole:'student',
          caseId:'c102', caseCategory:'Wages', timestamp:'2025-12-04T10:00:00Z',
          meta: {
              complexity: 4,
              claimAt:'2025-12-03T12:00:00Z',
              submitAt:'2025-12-04T10:00:00Z',
              ip:'198.51.100.60',
              deviceId:'dev-s1',
              draftText:'The worker is claiming unpaid wages and overtime; this draft sets out statutory rights and a clear payment timeline.'
          }
        },
        {
          id:'s1-r2', type:'review_result', actorId:'student-001', actorRole:'student',
          caseId:'c102', caseCategory:'Wages', timestamp:'2025-12-04T17:00:00Z',
          meta: { outcome:'revise' }
        },

        // S2: low-complexity farming + fast turnaround + repeated revise + template reuse
        {
          id:'s2-d1', type:'draft_submitted', actorId:'student-002', actorRole:'student',
          caseId:'c201', caseCategory:'Traffic', timestamp:'2025-12-01T10:00:00Z',
          meta: {
              complexity: 1,
              claimAt:'2025-12-01T08:30:00Z',
              submitAt:'2025-12-01T10:00:00Z',
              ip:'203.0.113.99',             // same as user-002 (reporter)
              deviceId:'dev-shared-01',      // shared device
              draftText:'Dear Sir, I am a daily wage worker stopped by traffic police. This template briefly describes the facts and requests lenient action.'
          }
        },
        {
          id:'s2-r1', type:'review_result', actorId:'student-002', actorRole:'student',
          caseId:'c201', caseCategory:'Traffic', timestamp:'2025-12-01T13:00:00Z',
          meta: { outcome:'revise' }
        },
        {
          id:'s2-d2', type:'draft_submitted', actorId:'student-002', actorRole:'student',
          caseId:'c202', caseCategory:'Rent', timestamp:'2025-12-02T10:15:00Z',
          meta: {
              complexity: 1,
              claimAt:'2025-12-02T09:00:00Z',
              submitAt:'2025-12-02T10:15:00Z',
              ip:'203.0.113.99',
              deviceId:'dev-shared-01',
              draftText:'Dear Sir, I am a daily wage tenant facing issues. This template briefly describes the facts and requests lenient action from the landlord.'
          }
        },
        {
          id:'s2-r2', type:'review_result', actorId:'student-002', actorRole:'student',
          caseId:'c202', caseCategory:'Rent', timestamp:'2025-12-02T14:00:00Z',
          meta: { outcome:'revise' }
        },
        {
          id:'s2-d3', type:'draft_submitted', actorId:'student-002', actorRole:'student',
          caseId:'c203', caseCategory:'Wages', timestamp:'2025-12-03T09:30:00Z',
          meta: {
              complexity: 2,
              claimAt:'2025-12-03T08:00:00Z',
              submitAt:'2025-12-03T09:30:00Z',
              ip:'203.0.113.99',
              deviceId:'dev-shared-01',
              draftText:'Dear Sir, I am a daily wage worker underpaid for three months. This template briefly describes the facts and requests full payment.'
          }
        },
        {
          id:'s2-r3', type:'review_result', actorId:'student-002', actorRole:'student',
          caseId:'c203', caseCategory:'Wages', timestamp:'2025-12-03T12:00:00Z',
          meta: { outcome:'revise' }
        },
        {
          id:'s2-d4', type:'draft_submitted', actorId:'student-002', actorRole:'student',
          caseId:'c204', caseCategory:'Traffic', timestamp:'2025-12-04T09:45:00Z',
          meta: {
              complexity: 1,
              claimAt:'2025-12-04T08:30:00Z',
              submitAt:'2025-12-04T09:45:00Z',
              ip:'203.0.113.99',
              deviceId:'dev-shared-01',
              draftText:'Dear Sir, I am a daily wage worker stopped by traffic police again. This template briefly repeats the facts and requests lenient action.'
          }
        },
        {
          id:'s2-r4', type:'review_result', actorId:'student-002', actorRole:'student',
          caseId:'c204', caseCategory:'Traffic', timestamp:'2025-12-04T13:00:00Z',
          meta: { outcome:'revise' }
        },

        // S3: only 1 submission, low suspicion
        {
          id:'s3-d1', type:'draft_submitted', actorId:'student-003', actorRole:'student',
          caseId:'c301', caseCategory:'Rent', timestamp:'2025-12-05T11:00:00Z',
          meta: {
              complexity: 3,
              claimAt:'2025-12-04T15:00:00Z',
              submitAt:'2025-12-05T11:00:00Z',
              ip:'198.51.100.90',
              deviceId:'dev-s3',
              draftText:'This draft explains the tenant‚Äôs rent arrears and proposes a realistic payment plan while asserting basic rights.'
          }
        },
        {
          id:'s3-r1', type:'review_result', actorId:'student-003', actorRole:'student',
          caseId:'c301', caseCategory:'Rent', timestamp:'2025-12-05T16:00:00Z',
          meta: { outcome:'approve' }
        }
    ];

    // Review records for reviewer-collusion detector:
    const reviews = [
        // Case X1: most give 5, R3 gives 10
        { reviewerId:'rev-001', studentId:'student-002', caseId:'c201', score:5, timestamp:'2025-12-02T10:00:00Z' },
        { reviewerId:'rev-002', studentId:'student-002', caseId:'c201', score:5, timestamp:'2025-12-02T10:05:00Z' },
        { reviewerId:'rev-003', studentId:'student-002', caseId:'c201', score:10, timestamp:'2025-12-02T10:10:00Z' },
        { reviewerId:'rev-004', studentId:'student-002', caseId:'c201', score:5, timestamp:'2025-12-02T10:15:00Z' },

        // Case X2: again R3 inflates
        { reviewerId:'rev-001', studentId:'student-002', caseId:'c202', score:6, timestamp:'2025-12-03T11:00:00Z' },
        { reviewerId:'rev-002', studentId:'student-002', caseId:'c202', score:5, timestamp:'2025-12-03T11:05:00Z' },
        { reviewerId:'rev-003', studentId:'student-002', caseId:'c202', score:10, timestamp:'2025-12-03T11:10:00Z' },
        { reviewerId:'rev-004', studentId:'student-002', caseId:'c202', score:6, timestamp:'2025-12-03T11:15:00Z' },

        // Case Y1: normal variation
        { reviewerId:'rev-001', studentId:'student-001', caseId:'c101', score:8, timestamp:'2025-12-04T09:00:00Z' },
        { reviewerId:'rev-002', studentId:'student-001', caseId:'c101', score:9, timestamp:'2025-12-04T09:05:00Z' },
        { reviewerId:'rev-003', studentId:'student-001', caseId:'c101', score:9, timestamp:'2025-12-04T09:10:00Z' }
    ];

    /*******************************
     * 3. UTILS & CROSS-ACCOUNT    *
     *******************************/

    function tokenize(text) {
        return text
            .toLowerCase()
            .replace(/[^a-z0-9\s]/g, ' ')
            .split(/\s+/)
            .filter(Boolean);
    }

    function jaccardSimilarity(tokensA, tokensB) {
        const setA = new Set(tokensA);
        const setB = new Set(tokensB);
        let intersection = 0;
        setA.forEach(t => { if (setB.has(t)) intersection++; });
        const union = setA.size + setB.size - intersection;
        return union === 0 ? 0 : intersection / union;
    }

    // Cross-account linkage: shared device/IP across reporters & students
    function computeCrossAccountSignals(allEvents) {
        const deviceIndex = {};
        const ipIndex = {};

        allEvents.forEach(e => {
            const m = e.meta || {};
            if (m.deviceId) {
                if (!deviceIndex[m.deviceId]) {
                    deviceIndex[m.deviceId] = {
                        roles: new Set(),
                        actorIds: new Set(),
                        reporters: new Set(),
                        students: new Set()
                    };
                }
                const entry = deviceIndex[m.deviceId];
                entry.roles.add(e.actorRole);
                entry.actorIds.add(e.actorId);
                if (e.actorRole === 'reporter') entry.reporters.add(e.actorId);
                if (e.actorRole === 'student') entry.students.add(e.actorId);
            }
            if (m.ip) {
                if (!ipIndex[m.ip]) {
                    ipIndex[m.ip] = {
                        roles: new Set(),
                        actorIds: new Set(),
                        reporters: new Set(),
                        students: new Set()
                    };
                }
                const entry = ipIndex[m.ip];
                entry.roles.add(e.actorRole);
                entry.actorIds.add(e.actorId);
                if (e.actorRole === 'reporter') entry.reporters.add(e.actorId);
                if (e.actorRole === 'student') entry.students.add(e.actorId);
            }
        });

        const reporterSignals = {};
        const studentSignals = {};

        function ensureReporter(id) {
            if (!reporterSignals[id]) {
                reporterSignals[id] = {
                    sharedReporterDevices: 0,
                    sharedReporterIps: 0,
                    crossRoleDevices: 0,
                    crossRoleIps: 0
                };
            }
            return reporterSignals[id];
        }

        function ensureStudent(id) {
            if (!studentSignals[id]) {
                studentSignals[id] = {
                    crossRoleDevices: 0,
                    crossRoleIps: 0
                };
            }
            return studentSignals[id];
        }

        // device-based signals
        Object.entries(deviceIndex).forEach(([deviceId, entry]) => {
            const reporters = Array.from(entry.reporters);
            const students = Array.from(entry.students);

            if (reporters.length > 1) {
                reporters.forEach(rid => {
                    const sig = ensureReporter(rid);
                    sig.sharedReporterDevices += reporters.length - 1;
                });
            }
            if (reporters.length > 0 && students.length > 0) {
                reporters.forEach(rid => {
                    const sig = ensureReporter(rid);
                    sig.crossRoleDevices += students.length;
                });
                students.forEach(sid => {
                    const sig = ensureStudent(sid);
                    sig.crossRoleDevices += reporters.length;
                });
            }
        });

        // ip-based signals
        Object.entries(ipIndex).forEach(([ip, entry]) => {
            const reporters = Array.from(entry.reporters);
            const students = Array.from(entry.students);

            if (reporters.length > 1) {
                reporters.forEach(rid => {
                    const sig = ensureReporter(rid);
                    sig.sharedReporterIps += reporters.length - 1;
                });
            }
            if (reporters.length > 0 && students.length > 0) {
                reporters.forEach(rid => {
                    const sig = ensureReporter(rid);
                    sig.crossRoleIps += students.length;
                });
                students.forEach(sid => {
                    const sig = ensureStudent(sid);
                    sig.crossRoleIps += reporters.length;
                });
            }
        });

        return { reporters: reporterSignals, students: studentSignals };
    }

    /*******************************
     * 4. DETECTOR IMPLEMENTATION  *
     *******************************/

    function detectReporterAbuse(allEvents, cfg, reporterCrossSignals) {
        const now = Date.now();
        const since = new Date(now - cfg.reporterLookbackDays * 24 * 3600 * 1000);
        const reporterMap = {};

        allEvents.forEach(e => {
            if (e.type !== 'case_created' || e.actorRole !== 'reporter') return;
            if (new Date(e.timestamp) < since) return;

            if (!reporterMap[e.actorId]) {
                reporterMap[e.actorId] = { count: 0, categories: new Set() };
            }
            reporterMap[e.actorId].count += 1;
            reporterMap[e.actorId].categories.add(e.caseCategory);
        });

        const results = [];
        const totalThresh = cfg.reporterTotalThresh;
        const categoryThresh = cfg.reporterCategoryThresh;

        for (const reporterId in reporterMap) {
            const data = reporterMap[reporterId];
            const total = data.count;
            const distinct = data.categories.size;

            let score = 0;
            const reasons = [];

            if (total >= totalThresh) {
                const extra = Math.min(1, (total - totalThresh + 1) / 5);
                score += 0.4 + 0.3 * extra;
                reasons.push(`High volume: ${total} cases in last ${cfg.reporterLookbackDays} days.`);
            }

            if (distinct >= categoryThresh) {
                const extra = Math.min(1, (distinct - categoryThresh + 1) / 4);
                score += 0.4 + 0.3 * extra;
                reasons.push(`Unrealistic mix: ${distinct} distinct dispute categories.`);
            }

            const cross = reporterCrossSignals && reporterCrossSignals[reporterId];
            if (cross) {
                if (cross.sharedReporterDevices > 0 || cross.sharedReporterIps > 0) {
                    score += 0.25;
                    reasons.push(`Shares device/IP with other reporter accounts (${cross.sharedReporterDevices + cross.sharedReporterIps} link(s)).`);
                }
                if (cross.crossRoleDevices > 0 || cross.crossRoleIps > 0) {
                    score += 0.35;
                    reasons.push(`Same device/IP also used by student account(s): possible self-fabricated cases.`);
                }
            }

            score = Math.min(1, score);
            results.push({
                reporterId,
                total,
                distinct,
                score,
                reasons
            });
        }

        return results;
    }

    function detectStudentFarming(allEvents, cfg, studentCrossSignals) {
        const now = Date.now();
        const since = new Date(now - cfg.studentLookbackDays * 24 * 3600 * 1000);
        const studentData = {};

        allEvents.forEach(e => {
            if (new Date(e.timestamp) < since) return;
            if (e.actorRole !== 'student') return;
            const sid = e.actorId;
            if (!studentData[sid]) {
                studentData[sid] = { submissions: [], reviewResults: [] };
            }
            if (e.type === 'draft_submitted') {
                studentData[sid].submissions.push(e);
            } else if (e.type === 'review_result') {
                studentData[sid].reviewResults.push(e);
            }
        });

        const results = [];
        const reviseThresh = cfg.reviseThresh;
        const lowComplexThresh = cfg.lowComplexThresh;
        const fastHoursThresh = cfg.fastHoursThresh;

        for (const sid in studentData) {
            const { submissions, reviewResults } = studentData[sid];
            const totalSubmissions = submissions.length;

            if (totalSubmissions === 0) {
                results.push({
                    studentId: sid,
                    totalSubmissions: 0,
                    reviseCount: 0,
                    lowComplexRatio: 0,
                    avgHours: null,
                    score: 0,
                    reasons: ['No submissions in window.']
                });
                continue;
            }

            const submissionsSorted = submissions.slice().sort(
                (a, b) => new Date(a.timestamp) - new Date(b.timestamp)
            );

            const reviseCount = reviewResults.filter(r => r.meta && r.meta.outcome === 'revise').length;

            const lowComplexCount = submissions.filter(
                s => s.meta && typeof s.meta.complexity === 'number' && s.meta.complexity <= 2
            ).length;
            const lowComplexRatio = lowComplexCount / totalSubmissions;

            const durations = submissions.map(s => {
                if (!s.meta || !s.meta.claimAt || !s.meta.submitAt) return null;
                return (new Date(s.meta.submitAt) - new Date(s.meta.claimAt)) / (3600 * 1000); // hours
            }).filter(v => v !== null);

            const avgHours = durations.length
                ? durations.reduce((acc, v) => acc + v, 0) / durations.length
                : null;

            let score = 0;
            const reasons = [];

            // Base signals: revise spam, low-complexity farming, ultra-fast turnaround
            if (reviseCount >= reviseThresh) {
                const extra = Math.min(1, (reviseCount - reviseThresh + 1) / 4);
                score += 0.6 + 0.2 * extra;
                reasons.push(`High review-sendbacks: ${reviseCount} drafts marked "revise".`);
            }

            if (lowComplexRatio >= lowComplexThresh) {
                const extra = Math.min(1, (lowComplexRatio - lowComplexThresh) / 0.3);
                score += 0.3 + 0.2 * extra;
                reasons.push(`Low-level farming: ${Math.round(lowComplexRatio * 100)}% of cases are low complexity.`);
            }

            if (avgHours !== null && avgHours < fastHoursThresh && totalSubmissions >= 3) {
                const boost = Math.min(1, (fastHoursThresh - avgHours) / fastHoursThresh);
                score += 0.3 * boost;
                reasons.push(`Very fast average turnaround: ${avgHours.toFixed(1)} hrs per case.`);
            }

            // 2.1 Progression model: complexity trend
            const complexityValues = submissionsSorted
                .map(s => s.meta && typeof s.meta.complexity === 'number' ? s.meta.complexity : null)
                .filter(v => v !== null);

            if (complexityValues.length >= 2) {
                const first = complexityValues[0];
                const last = complexityValues[complexityValues.length - 1];

                if (first <= 2 && last <= 2 && totalSubmissions >= 3) {
                    score += 0.25;
                    reasons.push('No progression: stuck on low-complexity files over time.');
                } else if (first <= 2 && last >= 3) {
                    score *= 0.85; // reward healthy progression
                    reasons.push('Healthy progression from low to higher complexity; risk slightly reduced.');
                }
            }

            // 2.1 Category experience vs new category speed
            const seenByCategory = {};
            let speedyNewCategoryCount = 0;

            submissionsSorted.forEach(s => {
                const cat = s.caseCategory || 'Unknown';
                const prevCount = seenByCategory[cat] || 0;

                let hours = null;
                if (s.meta && s.meta.claimAt && s.meta.submitAt) {
                    hours = (new Date(s.meta.submitAt) - new Date(s.meta.claimAt)) / (3600 * 1000);
                }

                if (prevCount === 0 && hours !== null && hours < 3 && totalSubmissions >= 3) {
                    speedyNewCategoryCount++;
                }

                seenByCategory[cat] = prevCount + 1;
            });

            if (speedyNewCategoryCount >= 2) {
                score += 0.3;
                reasons.push(`Very fast outputs in ${speedyNewCategoryCount} category/ies with no prior history.`);
            }

            // 2.x Draft similarity / template reuse within same student
            const draftsWithText = submissionsSorted.filter(
                s => s.meta && typeof s.meta.draftText === 'string' && s.meta.draftText.trim().length > 0
            );
            let highSimPairCount = 0;
            let maxSim = 0;

            if (draftsWithText.length >= 2) {
                const tokenized = draftsWithText.map(s => tokenize(s.meta.draftText));
                for (let i = 0; i < tokenized.length; i++) {
                    for (let j = i + 1; j < tokenized.length; j++) {
                        const sim = jaccardSimilarity(tokenized[i], tokenized[j]);
                        if (sim > 0.85) {
                            highSimPairCount++;
                        }
                        if (sim > maxSim) maxSim = sim;
                    }
                }
            }

            if (highSimPairCount > 0) {
                const sev = Math.min(1, highSimPairCount / 3);
                score += 0.3 + 0.2 * sev;
                reasons.push(`Template reuse: ${highSimPairCount} draft pair(s) share ‚â• 85% of tokens (max similarity ${(maxSim * 100).toFixed(1)}%).`);
            }

            // Cross-account linkage: same device/IP as reporter
            const cross = studentCrossSignals && studentCrossSignals[sid];
            if (cross && (cross.crossRoleDevices > 0 || cross.crossRoleIps > 0)) {
                score += 0.35;
                reasons.push('Same device/IP used for both reporter and student accounts (possible self-created cases).');
            }

            score = Math.min(1, score);

            results.push({
                studentId: sid,
                totalSubmissions,
                reviseCount,
                lowComplexRatio,
                avgHours,
                score,
                reasons: reasons.length ? reasons : ['No strong suspicious pattern detected.']
            });
        }

        return results;
    }

    function detectReviewerBias(allReviews, cfg) {
        const now = Date.now();
        const since = new Date(now - cfg.reviewerLookbackDays * 24 * 3600 * 1000);

        const recent = allReviews.filter(r => new Date(r.timestamp) >= since);
        const byCase = {};

        recent.forEach(r => {
            if (!byCase[r.caseId]) byCase[r.caseId] = [];
            byCase[r.caseId].push(r);
        });

        const diffsByReviewer = {};
        recent.forEach(r => {
            const list = byCase[r.caseId];
            if (!list || list.length < 2) return;
            const others = list.filter(x => x.reviewerId !== r.reviewerId);
            if (!others.length) return;

            const meanOthers = others.reduce((s, x) => s + x.score, 0) / others.length;
            const diff = r.score - meanOthers;

            if (!diffsByReviewer[r.reviewerId]) diffsByReviewer[r.reviewerId] = [];
            diffsByReviewer[r.reviewerId].push(diff);
        });

        const results = [];

        for (const reviewerId in diffsByReviewer) {
            const diffs = diffsByReviewer[reviewerId];
            if (!diffs.length) {
                results.push({
                    reviewerId,
                    casesReviewed: 0,
                    meanDiff: 0,
                    z: 0,
                    score: 0,
                    reasons: ['No comparable multi-review cases.']
                });
                continue;
            }

            const mean = diffs.reduce((a, b) => a + b, 0) / diffs.length;
            const variance = diffs.reduce((a, b) => a + (b - mean) * (b - mean), 0) / diffs.length;
            const std = Math.sqrt(variance);
            const z = std ? mean / std : (mean !== 0 ? 999 : 0);

            let score = 0;
            const reasons = [];

            if (Math.abs(mean) > 1.5) {
                score += 0.4;
                reasons.push(`Average scoring bias of ${mean.toFixed(2)} points vs peers.`);
            }

            if (Math.abs(z) > 2) {
                score += 0.4;
                reasons.push(`Bias is consistent across cases (z = ${z.toFixed(2)}).`);
            }

            score = Math.min(1, score);

            results.push({
                reviewerId,
                casesReviewed: diffs.length,
                meanDiff: mean,
                z,
                score,
                reasons: reasons.length ? reasons : ['No strong bias detected vs peers.']
            });
        }

        return results;
    }

    /**********************
     * 5. RENDER HELPERS  *
     **********************/
    function scoreClass(score) {
        if (score >= 0.7) return 'score-high';
        if (score >= 0.3) return 'score-med';
        return 'score-low';
    }

    function scoreLabel(score) {
        if (score >= 0.7) return 'High';
        if (score >= 0.3) return 'Medium';
        return 'Low';
    }

    function renderReporterTable(rows) {
        const body = document.getElementById('reporter-body');
        body.innerHTML = '';

        if (!rows.length) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="5" class="empty-row">No reporter data.</td>`;
            body.appendChild(tr);
            return;
        }

        rows.forEach(r => {
            const tr = document.createElement('tr');
            const sClass = scoreClass(r.score);
            tr.innerHTML = `
                <td>${r.reporterId}</td>
                <td>${r.total}</td>
                <td>${r.distinct}</td>
                <td>
                    <span class="score-badge ${sClass}">
                        <span class="dot"></span>
                        ${scoreLabel(r.score)} (${r.score.toFixed(2)})
                    </span>
                </td>
                <td>
                    ${r.reasons.map(reason => `<div class="reason">‚Ä¢ ${reason}</div>`).join('')}
                </td>
            `;
            body.appendChild(tr);
        });
    }

    function renderStudentTable(rows) {
        const body = document.getElementById('student-body');
        body.innerHTML = '';

        if (!rows.length) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="7" class="empty-row">No student submissions in window.</td>`;
            body.appendChild(tr);
            return;
        }

        rows.forEach(r => {
            const sClass = scoreClass(r.score);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${r.studentId}</td>
                <td>${r.totalSubmissions}</td>
                <td>${r.reviseCount}</td>
                <td>${Math.round(r.lowComplexRatio * 100)}%</td>
                <td>${r.avgHours === null ? '‚Äî' : r.avgHours.toFixed(1)}</td>
                <td>
                    <span class="score-badge ${sClass}">
                        <span class="dot"></span>
                        ${scoreLabel(r.score)} (${r.score.toFixed(2)})
                    </span>
                </td>
                <td>
                    ${r.reasons.map(reason => `<div class="reason">‚Ä¢ ${reason}</div>`).join('')}
                </td>
            `;
            body.appendChild(tr);
        });
    }

    function renderReviewerTable(rows) {
        const body = document.getElementById('reviewer-body');
        body.innerHTML = '';

        if (!rows.length) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="6" class="empty-row">No review data.</td>`;
            body.appendChild(tr);
            return;
        }

        rows.forEach(r => {
            const sClass = scoreClass(r.score);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${r.reviewerId}</td>
                <td>${r.casesReviewed}</td>
                <td>${r.meanDiff.toFixed(2)}</td>
                <td>${r.z.toFixed(2)}</td>
                <td>
                    <span class="score-badge ${sClass}">
                        <span class="dot"></span>
                        ${scoreLabel(r.score)} (${r.score.toFixed(2)})
                    </span>
                </td>
                <td>
                    ${r.reasons.map(reason => `<div class="reason">‚Ä¢ ${reason}</div>`).join('')}
                </td>
            `;
            body.appendChild(tr);
        });
    }

    function renderSummaryTiles(reporterRows, studentRows, reviewerRows) {
        const container = document.getElementById('summary-grid');
        container.innerHTML = '';

        const maxReporter = reporterRows.reduce((m,r)=>Math.max(m,r.score),0);
        const maxStudent  = studentRows.reduce((m,r)=>Math.max(m,r.score),0);
        const maxReviewer = reviewerRows.reduce((m,r)=>Math.max(m,r.score),0);

        const items = [
            { label: 'Reporter Suspicion', score: maxReporter, desc: 'Fake users filing unrealistic or repeated disputes.' },
            { label: 'Student Suspicion',  score: maxStudent,  desc: 'Farming low-level cases, template reuse or device overlap with reporters.' },
            { label: 'Reviewer Suspicion', score: maxReviewer, desc: 'Score inflation or collusion in peer review.' }
        ];

        items.forEach(item => {
            const score = item.score;
            let chipClass = 'chip-low';
            if (score >= 0.7) chipClass = 'chip-high';
            else if (score >= 0.3) chipClass = 'chip-med';

            const tile = document.createElement('div');
            tile.className = 'summary-tile';
            tile.innerHTML = `
                <div class="summary-label">${item.label}</div>
                <div class="summary-score-row">
                    <span class="summary-score">${score.toFixed(2)}</span>
                    <span class="summary-chip ${chipClass}">
                        <span class="dot"></span>
                        ${scoreLabel(score)}
                    </span>
                </div>
                <div class="summary-desc">${item.desc}</div>
            `;
            container.appendChild(tile);
        });
    }

    /**********************
     * 6. WIRE IT TO UI   *
     **********************/
    function runAllDetectors() {
        const crossSignals = computeCrossAccountSignals(events);

        const reporterResults = detectReporterAbuse(events, CONFIG, crossSignals.reporters);
        const studentResults  = detectStudentFarming(events, CONFIG, crossSignals.students);
        const reviewerResults = detectReviewerBias(reviews, CONFIG);

        renderReporterTable(reporterResults);
        renderStudentTable(studentResults);
        renderReviewerTable(reviewerResults);
        renderSummaryTiles(reporterResults, studentResults, reviewerResults);
    }

    document.getElementById('run-detectors-btn').addEventListener('click', runAllDetectors);

    // Initial run on load
    runAllDetectors();
</script>
</body>
</html>
