<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard - Legal Aid Platform</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background-color: #f3f4f6; color: #111827; min-height: 100vh;
  }
  .top-nav { background-color:#ffffff; border-bottom:1px solid #e5e7eb; padding:0.75rem 0; position:sticky; top:0; z-index:100; }
  .nav-content { max-width:1280px; margin:0 auto; padding:0 1rem; display:flex; align-items:center; gap:2rem; }
  .logo { font-size:1.5rem; font-weight:700; background:linear-gradient(135deg,#0a66c2 0%,#10b981 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; text-decoration:none; display:flex; align-items:center; gap:0.5rem; }
  .search-bar { flex:1; max-width:400px; }
  .search-bar input { width:100%; padding:0.625rem 1rem; border:1px solid #e5e7eb; border-radius:20px; background-color:#f9fafb; color:#111827; font-size:0.875rem; }
  .nav-actions { display:flex; gap:1rem; margin-left:auto; }
  .nav-btn { padding:0.5rem 1rem; background-color:transparent; border:1px solid #e5e7eb; border-radius:20px; color:#374151; font-size:0.875rem; cursor:pointer; transition:all 0.2s; }
  .nav-btn:hover { background-color:#f3f4f6; border-color:#0a66c2; }

  .container { max-width:1280px; margin:1.5rem auto; padding:0 1rem; display:grid; grid-template-columns:280px 1fr 320px; gap:1.5rem; }
  .profile-card { background-color:#ffffff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; height:fit-content; position:sticky; top:90px; }
  .profile-header { height:80px; background:linear-gradient(135deg,#0a66c2 0%,#10b981 100%); position:relative; }
  .profile-avatar { width:80px; height:80px; border-radius:50%; border:4px solid #ffffff; background:linear-gradient(135deg,#10b981 0%,#059669 100%); position:absolute; bottom:-40px; left:50%; transform:translateX(-50%); display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:600; color:#ffffff; }
  .profile-info { padding:3rem 1.5rem 1rem; text-align:center; border-bottom:1px solid #e5e7eb; }
  .profile-name { font-size:1.125rem; font-weight:700; margin-bottom:0.25rem; color:#111827; }
  .profile-title { font-size:0.875rem; color:#6b7280; margin-bottom:1rem; }
  .profile-bio { font-size:0.8rem; color:#6b7280; line-height:1.4; }
  .profile-stats { padding:1rem 1.5rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
  .stat-box { text-align:center; padding:0.75rem; background-color:#f9fafb; border-radius:8px; border:1px solid #e5e7eb; }
  .stat-value { font-size:1.5rem; font-weight:700; background:linear-gradient(135deg,#0a66c2 0%,#10b981 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:0.25rem; }
  .stat-label { font-size:0.75rem; color:#9ca3af; }
  .profile-achievements { padding:1rem 1.5rem; border-top:1px solid #e5e7eb; }
  .achievement-title { font-size:0.875rem; font-weight:600; color:#111827; margin-bottom:0.75rem; }
  .badges { display:flex; gap:0.5rem; flex-wrap:wrap; }
  .badge { padding:0.25rem 0.75rem; background:linear-gradient(135deg,#1d4ed8 0%,#1e40af 100%); border-radius:12px; font-size:0.75rem; color:#ffffff; }

  .main-content { display:flex; flex-direction:column; gap:1rem; }
  .card { background-color:#ffffff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; }
  .card-header { padding:1rem 1.5rem; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; }
  .card-title { font-size:1rem; font-weight:700; color:#111827; display:flex; align-items:center; gap:0.5rem; }
  .sort-dropdown { padding:0.375rem 0.75rem; background-color:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; color:#374151; font-size:0.8rem; cursor:pointer; }
  .category-filters { display:flex; gap:0.5rem; padding:1rem 1.5rem; border-bottom:1px solid #e5e7eb; overflow-x:auto; background-color:#ffffff; }
  .category-btn { padding:0.5rem 1.25rem; border:1px solid #e5e7eb; border-radius:20px; background-color:transparent; color:#6b7280; font-size:0.875rem; font-weight:600; cursor:pointer; transition:all 0.2s; white-space:nowrap; }
  .category-btn:hover { background-color:#f3f4f6; color:#111827; }
  .category-btn.active { background:linear-gradient(135deg,#0a66c2 0%,#10b981 100%); color:#ffffff; border-color:transparent; }

  .case-list { display:flex; flex-direction:column; background-color:#ffffff; }
  .case-item { padding:1.25rem 1.5rem; border-bottom:1px solid #e5e7eb; display:flex; gap:1rem; transition:background-color 0.2s; }
  .case-item:hover { background-color:#f9fafb; }
  .case-item:last-child { border-bottom:none; }
  .vote-section { display:flex; flex-direction:column; align-items:center; gap:0.25rem; color:#9ca3af; font-size:0.75rem; min-width:40px; }
  .vote-btn { background:none; border:none; color:#9ca3af; font-size:1.25rem; cursor:pointer; padding:0; line-height:1; transition:color 0.2s; }
  .vote-btn:hover { color:#10b981; }
  .vote-count { font-weight:700; }
  .case-icon { width:48px; height:48px; border-radius:8px; background:linear-gradient(135deg,#1d4ed8 0%,#1e40af 100%); display:flex; align-items:center; justify-content:center; font-size:1.5rem; flex-shrink:0; color:#ffffff; }
  .case-content { flex:1; min-width:0; }
  .case-header { display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; flex-wrap:wrap; }
  .case-author { font-size:0.75rem; color:#6b7280; }
  .case-time { font-size:0.75rem; color:#9ca3af; }
  .case-title { font-size:1rem; font-weight:600; color:#111827; margin-bottom:0.5rem; line-height:1.4; cursor:pointer; }
  .case-description { font-size:0.875rem; color:#4b5563; line-height:1.5; margin-bottom:0.75rem; }
  .case-tags { display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.75rem; }
  .tag { padding:0.25rem 0.75rem; background-color:#f3f4f6; border:1px solid #e5e7eb; border-radius:12px; font-size:0.75rem; color:#6b7280; }
  .tag.urgent { background-color:#fef2f2; border-color:#f97373; color:#b91c1c; }
  .tag.category { background:linear-gradient(135deg, rgba(10,102,194,0.1) 0%, rgba(16,185,129,0.1) 100%); border-color:#0a66c2; color:#1d4ed8; }
  .case-footer { display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap; }
  .case-action-btn { padding:0.5rem 1.25rem; background:linear-gradient(135deg,#0a66c2 0%,#10b981 100%); border:none; border-radius:20px; color:#ffffff; font-size:0.875rem; font-weight:600; cursor:pointer; transition:all 0.2s; }
  .case-action-btn:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(15,118,110,0.3); }
  .case-action-btn.secondary { background:transparent; border:1px solid #e5e7eb; color:#374151; }
  .case-action-btn.secondary:hover { background-color:#f3f4f6; border-color:#0a66c2; box-shadow:none; }
  .case-meta-btn { background:none; border:none; color:#6b7280; font-size:0.8rem; cursor:pointer; padding:0.25rem 0.5rem; display:flex; align-items:center; gap:0.25rem; transition:color 0.2s; }
  .case-meta-btn:hover { color:#111827; }
  .empty-state { text-align:center; padding:3rem 2rem; color:#6b7280; font-size:0.875rem; background-color:#ffffff; }
  .empty-state-icon { font-size:3rem; margin-bottom:1rem; opacity:0.5; }

  .right-sidebar { display:flex; flex-direction:column; gap:1rem; position:sticky; top:90px; height:fit-content; }
  .info-card { background-color:#ffffff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; }
  .info-header { padding:1rem 1.25rem; border-bottom:1px solid #e5e7eb; font-size:0.875rem; font-weight:700; color:#111827; display:flex; align-items:center; gap:0.5rem; }
  .info-content { padding:1rem 1.25rem; }
  .info-item { padding:0.75rem 0; border-bottom:1px solid #e5e7eb; }
  .info-item:last-child { border-bottom:none; padding-bottom:0; }
  .info-item-title { font-size:0.875rem; font-weight:600; color:#111827; margin-bottom:0.25rem; }
  .info-item-text { font-size:0.75rem; color:#6b7280; }
  .leaderboard-item { display:flex; align-items:center; gap:0.75rem; padding:0.75rem 0; border-bottom:1px solid #e5e7eb; }
  .leaderboard-item:last-child { border-bottom:none; padding-bottom:0; }
  .leaderboard-rank { font-size:1.25rem; min-width:32px; text-align:center; }
  .leaderboard-avatar { width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,#10b981 0%,#059669 100%); display:flex; align-items:center; justify-content:center; color:#ffffff; font-size:0.875rem; font-weight:700; border:2px solid #e5e7eb; }
  .leaderboard-info { flex:1; }
  .leaderboard-name { font-size:0.875rem; font-weight:600; color:#111827; margin-bottom:0.125rem; }
  .leaderboard-score { font-size:0.75rem; color:#6b7280; }

  @media (max-width: 1200px) { .container { grid-template-columns:260px 1fr; } .right-sidebar { display:none; } }
  @media (max-width: 900px) { .container { grid-template-columns:1fr; } .profile-card { position:relative; top:0; } }
  @media (max-width: 640px) { .nav-actions { display:none; } }

  /* --- Modal styles for Open Case File --- */
  .modal-backdrop { position:fixed; inset:0; background:rgba(2,6,23,0.6); display:none; align-items:center; justify-content:center; z-index:1200; }
  .modal { width: min(940px, 96%); background:white; border-radius:12px; box-shadow:0 30px 80px rgba(2,6,23,0.6); overflow:hidden; max-height:90vh; display:flex; flex-direction:column; }
  .modal-header { padding:16px 18px; border-bottom:1px solid #e6e9ef; display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .modal-body { padding:16px 18px; overflow:auto; }
  .modal-footer { padding:12px 18px; border-top:1px solid #e6e9ef; display:flex; gap:8px; justify-content:flex-end; }
  .close-btn { background:none; border:1px solid #e6e9ef; padding:6px 10px; border-radius:8px; cursor:pointer; }
  textarea { width:100%; min-height:160px; padding:10px; border-radius:8px; border:1px solid #e6e9ef; font-family:inherit; font-size:0.95rem; }
  .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; }
  .pill.allow { background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0; }
  .pill.revise { background:#fff7ed; color:#92400e; border:1px solid #f5d0a9; }
  .pill.block { background:#fff1f2; color:#991b1b; border:1px solid #fecaca; }

  .issues-list { margin-top:10px; padding-left:16px; color:#374151; }
  .issue-item { margin-bottom:6px; color:#9ca3af; font-size:0.9rem; }
</style>
</head>
<body>
  <nav class="top-nav">
    <div class="nav-content">
      <a href="../index.html" class="logo">
        <span>‚öñÔ∏è</span>
        <span>LegalAid</span>
      </a>
      <div class="search-bar">
        <input type="text" placeholder="Search cases, students, categories...">
      </div>
      <div class="nav-actions">
        <a href="./reviewer.html"><button class="nav-btn">üìä Reviews</button></a>
        <button class="nav-btn">üîî Alerts</button>
      </div>
    </div>
  </nav>

  <div class="container">
    <aside class="profile-card">
      <div class="profile-header">
        <div class="profile-avatar">SR</div>
      </div>
      <div class="profile-info">
        <div class="profile-name">Sarah Rodriguez</div>
        <div class="profile-title">Law Student ‚Ä¢ 3rd Year</div>
        <p class="profile-bio">Passionate about labor rights and housing justice. Seeking to make a difference.</p>
      </div>
      <div class="profile-stats">
        <div class="stat-box">
          <div class="stat-value">500</div>
          <div class="stat-label">Justice Rating</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">12</div>
          <div class="stat-label">Cases Solved</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="sidebar-progress">0</div>
          <div class="stat-label">In Progress</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">92%</div>
          <div class="stat-label">Success Rate</div>
        </div>
      </div>
      <div class="profile-achievements">
        <div class="achievement-title">üèÜ Achievements</div>
        <div class="badges">
          <span class="badge">Rising Star</span>
          <span class="badge">Quick Solver</span>
          <span class="badge">Helper</span>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><span class="card-title-icon">üîç</span>Browse Cases</h2>
          <select class="sort-dropdown">
            <option>Most Urgent</option><option>Recent</option><option>Popular</option>
          </select>
        </div>
        <div class="category-filters" id="category-filters">
          <button class="category-btn active" data-category="All">All Cases</button>
          <button class="category-btn" data-category="Rent">üè† Rent Disputes</button>
          <button class="category-btn" data-category="Wages">üí∞ Wage Issues</button>
          <button class="category-btn" data-category="Harassment">‚ö†Ô∏è Harassment</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h2 class="card-title"><span class="card-title-icon">üìã</span>Available Cases</h2></div>
        <div class="case-list" id="unclaimed-cases"></div>
      </div>

      <div class="card">
        <div class="card-header"><h2 class="card-title"><span class="card-title-icon">üíº</span>My Active Cases</h2></div>
        <div class="case-list" id="my-cases"></div>
      </div>
    </main>

    <aside class="right-sidebar">
      <div class="info-card">
        <div class="info-header"><span>‚ö°</span><span>Recent Updates</span></div>
        <div class="info-content">
          <div class="info-item"><div class="info-item-title">New case available</div><div class="info-item-text">Rent dispute in Mumbai ‚Ä¢ 2h ago</div></div>
          <div class="info-item"><div class="info-item-title">Case resolved</div><div class="info-item-text">Wage issue case #234 ‚Ä¢ 5h ago</div></div>
          <div class="info-item"><div class="info-item-title">Rating increased</div><div class="info-item-text">+50 points earned ‚Ä¢ 1d ago</div></div>
        </div>
      </div>

      <div class="info-card">
        <div class="info-header"><span>üèÜ</span><span>Top Students</span></div>
        <div class="info-content">
          <div class="leaderboard-item"><div class="leaderboard-rank">ü•á</div><div class="leaderboard-avatar">AK</div><div class="leaderboard-info"><div class="leaderboard-name">Amit Kumar</div><div class="leaderboard-score">850 points ‚Ä¢ 24 cases</div></div></div>
          <div class="leaderboard-item"><div class="leaderboard-rank">ü•à</div><div class="leaderboard-avatar">PR</div><div class="leaderboard-info"><div class="leaderboard-name">Priya Sharma</div><div class="leaderboard-score">720 points ‚Ä¢ 19 cases</div></div></div>
          <div class="leaderboard-item"><div class="leaderboard-rank">ü•â</div><div class="leaderboard-avatar">MG</div><div class="leaderboard-info"><div class="leaderboard-name">Mehul Gupta</div><div class="leaderboard-score">680 points ‚Ä¢ 17 cases</div></div></div>
        </div>
      </div>

      <div class="info-card">
        <div class="info-header"><span>üí°</span><span>Tips</span></div>
        <div class="info-content">
          <div class="info-item"><div class="info-item-title">Read carefully</div><div class="info-item-text">Take time to understand all case details</div></div>
          <div class="info-item"><div class="info-item-title">Prioritize urgent cases</div><div class="info-item-text">High priority cases need faster response</div></div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Modal: Open Case File -->
  <div id="case-modal-backdrop" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header">
        <div>
          <div id="modal-case-title" style="font-weight:700;font-size:1.05rem;">Case title</div>
          <div id="modal-case-meta" style="color:#6b7280;font-size:0.9rem;margin-top:6px;"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <div id="modal-decision-pill"></div>
          <button class="close-btn" id="modal-close-btn">Close</button>
        </div>
      </div>
      <div class="modal-body">
        <div style="display:flex;gap:12px;">
          <div style="flex:1;">
            <h3 style="margin-bottom:8px;">Citizen Evidence</h3>
            <div id="modal-evidence" style="background:#f9fafb;border:1px solid #e6e9ef;padding:12px;border-radius:8px;margin-bottom:14px;color:#374151;">
              <!-- evidence list -->
            </div>

            <h3 style="margin-bottom:8px;">Solution Text (for client)</h3>
            <textarea id="modal-draft" placeholder="Draft the notice / complaint / advice here for the client..."></textarea>

            <div style="margin-top:10px;">
              <label style="font-size:0.85rem;font-weight:600;">Documents to request from client (optional)</label>
              <textarea id="modal-docs-needed" style="margin-top:4px;min-height:80px;" placeholder="List any supporting documents you need the client to upload..."></textarea>
            </div>

            <div style="margin-top:10px;">
              <label style="font-size:0.85rem;font-weight:600;">Attach Solution Files (PDF, DOC, etc.)</label>
              <input type="file" id="modal-solution-files" multiple>
            </div>

            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
              <div>
                <label style="font-size:0.85rem;font-weight:600;">Solution Audio (optional)</label><br>
                <input type="file" id="modal-solution-voice" accept="audio/*">
              </div>
              <div>
                <label style="font-size:0.85rem;font-weight:600;">Solution Video (optional)</label><br>
                <input type="file" id="modal-solution-video" accept="video/*">
              </div>
            </div>

            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
              <button id="modal-save-draft" class="case-action-btn" style="padding:8px 12px;font-size:0.9rem;">üíæ Save Draft (local)</button>
              <button id="modal-run-moderation" class="case-action-btn secondary" style="padding:8px 12px;font-size:0.9rem;">üîé Run Moderation</button>
              <button id="modal-submit" class="case-action-btn" style="padding:8px 12px;font-size:0.9rem;">üì§ Submit Solution</button>
            </div>

            <div id="modal-issues" style="margin-top:12px;display:none;">
              <div style="font-weight:700;margin-bottom:6px;">Moderation Issues</div>
              <div id="modal-issues-list" class="issues-list"></div>
              <div id="modal-suggested-fix" style="margin-top:8px;color:#065f46;"></div>
            </div>
          </div>

          <aside style="width:320px;">
            <h3 style="margin-bottom:8px;">Case Summary</h3>
            <div id="modal-summary" style="background:#f9fafb;border:1px solid #e6e9ef;padding:12px;border-radius:8px;color:#374151;"></div>

            <h3 style="margin-top:12px;margin-bottom:8px;">Status & History</h3>
            <div id="modal-history" style="background:#f9fafb;border:1px solid #e6e9ef;padding:12px;border-radius:8px;color:#374151;min-height:120px;">
              <!-- history entries -->
            </div>
          </aside>
        </div>
      </div>
      <div class="modal-footer">
        <button id="modal-close-bottom" class="close-btn">Close</button>
      </div>
    </div>
  </div>

<script>
  // ===== API & STATE =====
  const API_BASE = "http://localhost:3000";
  const currentStudentName = "Sarah Rodriguez";
  let allCases = [];
  let currentCategory = "All";
  let activeCaseId = null;

  // ===== HELPERS =====
  function formatCategory(cat) {
    if (!cat) return "Other";
    const key = String(cat).toLowerCase();
    const map = {
      rent: "Rent",
      wages: "Wages",
      harassment: "Harassment",
      fraud: "Fraud",
      family: "Family",
      other: "Other",
      inreview: "Other"
    };
    return map[key] || (key.charAt(0).toUpperCase() + key.slice(1));
  }

  function formatLanguage(code) {
    if (!code) return "Not specified";
    const map = {
      en: "English", hi: "Hindi", bn: "Bengali", te: "Telugu",
      mr: "Marathi", ta: "Tamil", gu: "Gujarati", kn: "Kannada",
      ml: "Malayalam", or: "Odia", pa: "Punjabi", as: "Assamese", ur: "Urdu"
    };
    return map[code] || code;
  }

  function getCategoryIcon(category) {
    const key = (category || "").toLowerCase();
    const icons = { rent: "üè†", wages: "üí∞", harassment: "‚ö†Ô∏è", fraud: "‚öñÔ∏è", family: "üë®‚Äçüë©‚Äçüëß", other: "üìã" };
    return icons[key] || "üìã";
  }

  function timeLabel(iso) {
    if (!iso) return "Recently";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "Recently";
    return d.toLocaleString();
  }

  // ===== LOAD CASES FROM BACKEND =====
  async function loadCases() {
    const unclaimedContainer = document.getElementById("unclaimed-cases");
    try {
      const res = await fetch(`${API_BASE}/api/get-cases`);
      if (!res.ok) throw new Error("Network error: " + res.status);
      const data = await res.json();
      allCases = Array.isArray(data) ? data : [];
      renderUnclaimedCases();
      renderMyCases();
    } catch (err) {
      console.error("Failed to load cases", err);
      if (unclaimedContainer) {
        unclaimedContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <div>Could not load cases.</div>
            <div style="margin-top: 0.5rem; font-size: 0.75rem;">Is the Node server running on http://localhost:3000 ?</div>
          </div>
        `;
      }
    }
  }

  // ===== CLAIM / ACCEPT CASE =====
  async function claimCase(id) {
    try {
      const res = await fetch(`${API_BASE}/api/accept-case`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, studentName: currentStudentName })
      });
      const data = await res.json();
      if (!data.success) {
        alert(data.message || "Server error while accepting case");
        return;
      }
      alert("Case accepted and assigned to you.");
      await loadCases();
    } catch (e) {
      console.error(e);
      alert("Network error while accepting case.");
    }
  }
  window.claimCase = claimCase;

  // ===== RENDER AVAILABLE (UNCLAIMED) CASES =====
  function renderUnclaimedCases() {
    const container = document.getElementById("unclaimed-cases");
    if (!allCases || allCases.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚åõ</div>
          <div>No cases yet. Waiting for citizens to submit.</div>
        </div>
      `;
      return;
    }

    const filtered = allCases.filter(c => {
      const status = (c.status || "").toLowerCase();
      const isUnclaimed = !c.acceptedBy && (status === "in review" || status === "inreview" || status === "");
      const catOk = currentCategory === "All" ||
        ((c.category || "").toLowerCase() === currentCategory.toLowerCase());
      return isUnclaimed && catOk;
    });

    if (filtered.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üì≠</div>
          <div>No available cases in this category right now.</div>
          <div style="margin-top: 0.5rem; font-size: 0.75rem;">Check back later or browse other categories.</div>
        </div>
      `;
      return;
    }

    container.innerHTML = filtered.map(c => {
      const citizenName = c.name && c.name.trim() ? c.name.trim() : "Anonymous Citizen";
      const catLabel = formatCategory(c.category);
      const loc = c.location || "Unknown location";
      const desc = (c.description || "").length > 160
        ? c.description.slice(0, 157) + "..."
        : (c.description || "No detailed description.");
      const statusLabel = c.status || "In Review";
      return `
        <div class="case-item">
          <div class="vote-section">
            <button class="vote-btn">‚ñ≤</button>
            <div class="vote-count">0</div>
            <button class="vote-btn">‚ñº</button>
          </div>
          <div class="case-icon">${getCategoryIcon(c.category)}</div>
          <div class="case-content">
            <div class="case-header">
              <span class="case-author">${citizenName}</span>
              <span class="case-time">‚Ä¢ ${timeLabel(c.createdAt)}</span>
            </div>
            <div class="case-title" onclick="openCaseFile('${c.id}')">${c.title || "(no title)"}</div>
            <div class="case-description">
              ${loc} ‚Äì ${desc}
            </div>
            <div class="case-tags">
              <span class="tag category">${catLabel}</span>
              <span class="tag">Status: ${statusLabel}</span>
              <span class="tag">${loc}</span>
            </div>
            <div class="case-footer">
              <button class="case-action-btn" onclick="claimCase('${c.id}')">‚úî Accept Case</button>
              <button class="case-action-btn secondary" onclick="openCaseFile('${c.id}')">üëÅ Show Case</button>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  // ===== RENDER MY ACTIVE CASES =====
  function renderMyCases() {
    const container = document.getElementById("my-cases");
    if (!allCases || allCases.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚åõ</div>
          <div>Loading your cases...</div>
        </div>
      `;
      return;
    }

    const mine = allCases.filter(c => c.acceptedBy === currentStudentName);

    const sidebarProgress = document.getElementById("sidebar-progress");
    if (sidebarProgress) sidebarProgress.textContent = mine.filter(c => (c.status || "").toLowerCase() !== "solved").length;

    if (mine.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üíº</div>
          <div>You haven't accepted any cases yet.</div>
          <div style="margin-top: 0.5rem; font-size: 0.75rem;">Start by accepting a case above to begin your journey!</div>
        </div>
      `;
      return;
    }

    container.innerHTML = mine.map(c => {
      const citizenName = c.name && c.name.trim() ? c.name.trim() : "Anonymous Citizen";
      const catLabel = formatCategory(c.category);
      const status = c.status || "Accepted";
      const isSolved = status.toLowerCase() === "solved";
      const statusColor = isSolved
        ? "background-color: #ecfdf5; color: #047857; border-color: #a7f3d0;"
        : "background-color: #eff6ff; color: #1d4ed8; border-color: #bfdbfe;";
      return `
        <div class="case-item">
          <div class="case-icon" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">‚ö°</div>
          <div class="case-content">
            <div class="case-header">
              <span class="case-author">${citizenName}</span>
              <span class="case-time">‚Ä¢ Accepted: ${timeLabel(c.createdAt)}</span>
            </div>
            <div class="case-title" onclick="openCaseFile('${c.id}')">${c.title || "(no title)"}</div>
            <div class="case-description">
              You are currently representing this client. Please review the uploaded documents and submit a solution.
            </div>
            <div class="case-tags">
              <span class="tag category">${catLabel}</span>
              <span class="tag" style="${statusColor}">${status}</span>
            </div>
            <div class="case-footer">
              <button class="case-action-btn" onclick="openCaseFile('${c.id}')">üìÇ Open Case File</button>
              <button class="case-action-btn secondary" onclick="updateStatus('${c.id}')">Status Info</button>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  // ===== STATUS INFO (no backend change) =====
  window.updateStatus = function(caseId) {
    alert(
      "Status is handled by the system:\n\n" +
      "‚Ä¢ 'In Review' ‚Äì citizen submitted the case\n" +
      "‚Ä¢ 'Accepted' ‚Äì you accepted the case\n" +
      "‚Ä¢ 'Solved' ‚Äì you submitted a solution\n\n" +
      "To change status to 'Solved', open the case file and submit your solution."
    );
  };

  // ===== CATEGORY FILTER HANDLER =====
  document.getElementById('category-filters').addEventListener('click', (e) => {
    if (e.target.classList.contains('category-btn')) {
      document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
      e.target.classList.add('active');
      currentCategory = e.target.getAttribute('data-category') || "All";
      renderUnclaimedCases();
    }
  });

  // ===== MODAL ELEMENTS =====
  const modalBackdrop = document.getElementById('case-modal-backdrop');
  const modalCloseBtn = document.getElementById('modal-close-btn');
  const modalCloseBottom = document.getElementById('modal-close-bottom');
  const modalCaseTitle = document.getElementById('modal-case-title');
  const modalCaseMeta = document.getElementById('modal-case-meta');
  const modalEvidence = document.getElementById('modal-evidence');
  const modalSummary = document.getElementById('modal-summary');
  const modalHistory = document.getElementById('modal-history');
  const modalDraft = document.getElementById('modal-draft');
  const modalDocsNeeded = document.getElementById('modal-docs-needed');
  const modalFilesInput = document.getElementById('modal-solution-files');
  const modalVoiceInput = document.getElementById('modal-solution-voice');
  const modalVideoInput = document.getElementById('modal-solution-video');
  const modalSaveDraft = document.getElementById('modal-save-draft');
  const modalRunModeration = document.getElementById('modal-run-moderation');
  const modalIssues = document.getElementById('modal-issues');
  const modalIssuesList = document.getElementById('modal-issues-list');
  const modalSuggestedFix = document.getElementById('modal-suggested-fix');
  const modalDecisionPill = document.getElementById('modal-decision-pill');
  const modalSubmit = document.getElementById('modal-submit');

  // ===== OPEN CASE FILE MODAL =====
  window.openCaseFile = function(caseId) {
    const cid = String(caseId);
    const c = allCases.find(x => String(x.id) === cid);
    if (!c) {
      alert('Case not found.');
      return;
    }

    activeCaseId = cid;

    const citizenName = c.name && c.name.trim() ? c.name.trim() : "Anonymous Citizen";
    const catLabel = formatCategory(c.category);
    const loc = c.location || "Unknown location";
    const created = timeLabel(c.createdAt);
    const status = c.status || "In Review";
    const sol = c.solution || {};

    // Header
    modalCaseTitle.textContent = c.title || "(no title)";
    modalCaseMeta.textContent = `${catLabel} ‚Ä¢ ${loc} ‚Ä¢ Status: ${status}`;

    // Evidence: documents + citizen audio/video
    const evidenceParts = [];
    if (Array.isArray(c.proofs) && c.proofs.length) {
      evidenceParts.push("<div style='margin-bottom:6px;font-weight:600;'>Documents:</div>");
      evidenceParts.push(
        c.proofs.map((p, idx) =>
          `<div style="padding:4px 0;"><a href="${API_BASE}${p}" target="_blank">üìé Evidence ${idx + 1}</a></div>`
        ).join("")
      );
    }
    if (c.voice) {
      evidenceParts.push("<div style='margin-top:8px;font-weight:600;'>Citizen Audio:</div>");
      evidenceParts.push(`<audio controls src="${API_BASE}${c.voice}" style="width:100%;margin-top:4px;"></audio>`);
    }
    if (c.video) {
      evidenceParts.push("<div style='margin-top:8px;font-weight:600;'>Citizen Video:</div>");
      evidenceParts.push(`<video controls src="${API_BASE}${c.video}" style="width:100%;max-height:260px;margin-top:4px;"></video>`);
    }
    modalEvidence.innerHTML = evidenceParts.length
      ? evidenceParts.join("")
      : `<div style="color:#6b7280;">No uploaded evidence for this case.</div>`;

    // Summary
    const descHtml = (c.description || "").replace(/\n/g, "<br>");
    modalSummary.innerHTML = `
      <strong>Citizen:</strong> ${citizenName}<br>
      <strong>Case ID:</strong> ${c.id}<br>
      <strong>Language:</strong> ${formatLanguage(c.language)}<br>
      <strong>Reported:</strong> ${created}<br>
      <div style="margin-top:6px;color:#6b7280;font-size:0.95rem;max-height:160px;overflow:auto;">
        ${descHtml || "No detailed description provided."}
      </div>
    `;

    // History / timeline
    const history = [];
    history.push(`
      <div style="margin-bottom:8px;">
        <strong>System</strong> ‚Ä¢ Case created
        <div style="color:#6b7280;font-size:0.9rem;">${created}</div>
      </div>
    `);
    if (c.acceptedBy) {
      history.push(`
        <div style="margin-bottom:8px;">
          <strong>${c.acceptedBy}</strong> ‚Ä¢ Accepted the case
          <div style="color:#6b7280;font-size:0.9rem;">(time when accepted not stored; shown as reported time)</div>
        </div>
      `);
    }
    if (sol.status === "submitted") {
      history.push(`
        <div style="margin-bottom:8px;">
          <strong>${sol.studentName || c.acceptedBy || "Student"}</strong> ‚Ä¢ Submitted solution
          <div style="color:#6b7280;font-size:0.9rem;">${timeLabel(sol.submittedAt)}</div>
        </div>
      `);
    }
    modalHistory.innerHTML = history.join("");

    // Fill solution section
    modalDraft.value = sol.text || "";
    modalDocsNeeded.value = sol.docsNeeded || "";
    modalFilesInput.value = "";
    modalVoiceInput.value = "";
    modalVideoInput.value = "";

    // If solution already submitted, disable re-submission but still show content
    const alreadySubmitted = sol.status === "submitted";
    modalSubmit.disabled = alreadySubmitted;
    modalSubmit.textContent = alreadySubmitted ? "Solution already submitted" : "üì§ Submit Solution";

    // Clear moderation UI
    modalIssues.style.display = "none";
    modalIssuesList.innerHTML = "";
    modalSuggestedFix.textContent = "";
    modalDecisionPill.innerHTML = "";

    // Show modal
    modalBackdrop.style.display = 'flex';
    modalBackdrop.setAttribute('aria-hidden', 'false');
  };

  function closeModal() {
    modalBackdrop.style.display = 'none';
    modalBackdrop.setAttribute('aria-hidden', 'true');
    activeCaseId = null;
  }

  modalCloseBtn.addEventListener('click', closeModal);
  modalCloseBottom.addEventListener('click', closeModal);

  // Save draft locally only (doesn't touch backend)
  modalSaveDraft.addEventListener('click', () => {
    if (!activeCaseId) return alert('No active case.');
    const idx = allCases.findIndex(x => String(x.id) === String(activeCaseId));
    if (idx === -1) return alert('Case not found.');
    allCases[idx].draft = modalDraft.value;
    alert('Draft saved locally (not sent to server).');
    renderMyCases();
  });

  // ===== LOCAL MODERATION (same logic) =====
  function runLocalModeration(text) {
    const issues = [];
    const lower = (text || '').toLowerCase();

    const uplPatterns = [
      /i will represent you/, /i'll represent you/, /i will file/, /i'll file/, /i will appear/, /i'll appear/,
      /i will handle your case/, /i'll handle your case/, /retainer/, /my fees/, /pay me/, /send me fees/,
      /i will go to court/, /i'll go to court/
    ];
    if (uplPatterns.some(re => re.test(lower))) {
      issues.push({ type:'block', msg:'Unauthorized Practice: contains promises of representation or fee requests.'});
    }

    const directAdvicePatterns = [
      /\byou must\b/, /\byou should\b/, /\byou have to\b/, /\bdo this\b/, /\bjust do this\b/, /\bgo and file\b/, /\bfile a case immediately\b/
    ];
    if (directAdvicePatterns.some(re => re.test(lower))) {
      issues.push({ type:'revise', msg:'No direct imperative legal advice: rephrase into options (A/B/C).'});
    }

    const pii = [];
    if (/\b[6-9]\d{9}\b/.test(lower)) pii.push('phone number');
    if (/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i.test(text)) pii.push('email');
    if (/\b\d{4}\s?\d{4}\s?\d{4}\b/.test(text)) pii.push('Aadhaar-like number');
    if (pii.length) issues.push({ type:'revise', msg:`Privacy: remove or mask ${pii.join(', ')}.` });

    const promo = [/contact me/,/call me/,/whatsapp me/,/my firm/,/consultation fee/,/pay me/,/upi id/,/bank account/];
    if (promo.some(re => re.test(lower))) issues.push({ type:'revise', msg:'Remove private contact details or fee requests.' });

    const illegal = [/kill/,/beat them/,/violence/,/bribe/,/forge/,/forgery/,/threaten/,/burn/,/kidnap/];
    if (illegal.some(re => re.test(lower))) issues.push({ type:'block', msg:'Illegal or unsafe instruction detected (violence, forgery, bribery).' });

    const rude = [/idiot/,/stupid/,/dumb/,/moron/,/bastard/];
    if (rude.some(re => re.test(lower))) issues.push({ type:'revise', msg:'Please remove insults; maintain professional neutral tone.' });

    const misleading = [/100% win/,/guarantee/,/guaranteed win/,/you will definitely win/];
    if (misleading.some(re => re.test(lower))) issues.push({ type:'revise', msg:'Avoid guarantees or absolute claims about outcomes.' });

    let decision = 'allow';
    if (issues.some(i => i.type === 'block')) decision = 'block';
    else if (issues.some(i => i.type === 'revise')) decision = 'revise';

    let suggested = '';
    if (decision === 'revise') {
      suggested = 'Rewrite so you: explain rights, present lawful options (A/B/C), avoid promises of representation, remove PII/self-promo, stay neutral.';
    } else if (decision === 'block') {
      suggested = 'Remove illegal/unsafe instructions or promises of representation. Seek supervisor review.';
    } else {
      suggested = 'Looks good for submission (still consider asking clarifying questions if needed).';
    }

    return { decision, issues, suggestedFix: suggested };
  }

  function presentModerationResult(result) {
    modalIssues.style.display = 'block';
    modalIssuesList.innerHTML = '';
    modalSuggestedFix.textContent = result.suggestedFix || '';

    modalDecisionPill.innerHTML = '';
    const pill = document.createElement('div');
    pill.className = 'pill ' + (result.decision === 'allow' ? 'allow' : (result.decision === 'revise' ? 'revise' : 'block'));
    pill.textContent = (result.decision === 'allow' ? 'ALLOW' : (result.decision === 'revise' ? 'REVISE' : 'BLOCK'));
    modalDecisionPill.appendChild(pill);

    if (result.issues && result.issues.length) {
      result.issues.forEach(i => {
        const div = document.createElement('div');
        div.className = 'issue-item';
        div.textContent = '‚Ä¢ ' + i.msg;
        modalIssuesList.appendChild(div);
      });
    } else {
      modalIssuesList.innerHTML = '<div style="color:#6b7280;">No issues found.</div>';
    }
  }

  modalRunModeration.addEventListener('click', () => {
    const text = modalDraft.value || '';
    if (!text.trim()) return alert('Please write something to run moderation.');
    const res = runLocalModeration(text);
    presentModerationResult(res);
  });

  // ===== SUBMIT SOLUTION TO BACKEND =====
  modalSubmit.addEventListener('click', async () => {
    if (!activeCaseId) return alert("No active case.");
    if (modalSubmit.disabled) {
      alert("Solution is already submitted for this case.");
      return;
    }

    const solutionText = (modalDraft.value || "").trim();
    if (!solutionText) {
      alert("Please write solution text before submitting.");
      return;
    }

    const docsNeeded = (modalDocsNeeded.value || "").trim();

    const fd = new FormData();
    fd.append("id", activeCaseId);
    fd.append("studentName", currentStudentName);
    fd.append("solutionText", solutionText);
    fd.append("docsNeeded", docsNeeded);

    for (const f of modalFilesInput.files) {
      fd.append("solutionFiles", f);
    }
    if (modalVoiceInput.files[0]) {
      fd.append("solutionVoice", modalVoiceInput.files[0]);
    }
    if (modalVideoInput.files[0]) {
      fd.append("solutionVideo", modalVideoInput.files[0]);
    }

    try {
      const res = await fetch(`${API_BASE}/api/submit-solution`, {
        method: "POST",
        body: fd
      });
      const data = await res.json();
      if (!data.success) {
        alert(data.message || "Server error while submitting solution");
        return;
      }
      alert("Solution submitted successfully. Status will now be 'Solved'.");
      closeModal();
      await loadCases();
    } catch (e) {
      console.error(e);
      alert("Network error while submitting solution.");
    }
  });

  // Load on initial page
  loadCases();

  // Close modal on ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modalBackdrop.style.display === 'flex') closeModal();
  });
</script>
</body>
</html>
